<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Reserva de turnos</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
body { font-family: Arial, sans-serif; margin: 20px; background: #f9f9f9; }
h1, h2 { color: #333; }
label { display: block; margin-bottom: 10px; font-weight: bold; }
input { width: 100%; padding: 8px; margin-top: 4px; box-sizing: border-box; }

.turno { padding: 12px; margin: 10px 0; border-radius: 8px; transition: transform 0.2s, box-shadow 0.2s, background 0.5s; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; }
.turno.disponible { background-color: #e6f9e6; border: 2px solid #4CAF50; }
.turno.disponible:hover { transform: translateY(-2px); box-shadow: 0 4px 8px rgba(0,0,0,0.1); }
.turno.bajo { background-color: #fff8e1; border: 2px solid #FFA500; }
.turno.ocupado { background-color: #ddd; border: 2px solid #aaa; opacity: 0.7; }

.turno div { flex: 1 1 60%; min-width: 150px; }
.cupos { font-weight: bold; transition: color 0.5s, transform 0.3s; }

button { padding: 10px 18px; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; transition: background 0.2s, transform 0.2s; flex: 1 1 35%; min-width: 120px; margin-top: 8px; }
button:hover { transform: translateY(-1px); }
button:disabled { cursor: not-allowed; opacity: 0.5; }
button.apuntarse { background-color: #4CAF50; color: white; }

@media (max-width: 600px) {
  .turno { flex-direction: column; align-items: flex-start; }
  .turno div { width: 100%; margin-bottom: 8px; }
  button { width: 100%; }
}
</style>
</head>
<body>
<h1>Colaboración de turnos</h1>
<h1>Fiestas Buztintxuri 2025</h1>  

<h2>Datos de contacto</h2>
<label>Nombre: <input type="text" id="nombre"></label>
<label>Teléfono: <input type="text" id="telefono" placeholder="+34 600-123-456"></label>

<h2>Turnos disponibles</h2>
<div id="turnos"></div>

<script>
const API_URL = "PEGAR_AQUI_LA_URL_DEL_SCRIPT"; // Reemplaza con tu URL de Apps Script
let refrescoInterval;
let turnosPrevios = {};

async function cargarTurnos() {
  const res = await fetch(API_URL);
  const turnos = await res.json();
  const cont = document.getElementById("turnos");

  turnos.forEach(t => {
    const key = t.dia + t.horario;
    let div = document.getElementById(key);

    if (!div) { 
      div = document.createElement("div"); 
      div.id = key; 
      cont.appendChild(div); 
    }

    if (t.cupos == 0) div.className = "turno ocupado";
    else if (t.cupos <= 3) div.className = "turno bajo";
    else div.className = "turno disponible";

    let prev = turnosPrevios[key] || 0;
    let animClass = "";
    if (t.cupos > prev) animClass = "aumento";
    else if (t.cupos < prev) animClass = "disminucion";

    div.innerHTML = `
      <div>
        <strong>${t.dia} ${t.horario}</strong><br>
        Cupos: <span class="cupos ${animClass}">${t.cupos}</span>
      </div>
      <button class="apuntarse" onclick="apuntarse('${t.dia}','${t.horario}')" ${t.cupos==0?"disabled":""}>Apuntarse</button>
    `;

    if (animClass) {
      const span = div.querySelector(".cupos");
      span.style.color = animClass === "aumento" ? "#4CAF50" : "#FF5722";
      span.style.transform = "scale(1.3)";
      setTimeout(() => { span.style.color = ""; span.style.transform = ""; }, 500);
    }

    turnosPrevios[key] = t.cupos;
  });
}

async function apuntarse(dia, horario) {
  const nombre = document.getElementById("nombre").value.trim();
  const telefono = document.getElementById("telefono").value.trim();

  if (!nombre || !telefono) { 
    alert("Rellena nombre y teléfono"); 
    return; 
  }

  // Validación flexible del teléfono
  if (!/^\+?[0-9\s\-()]+$/.test(telefono)) {
    alert("El teléfono solo puede contener números, espacios, guiones, paréntesis o un + al inicio");
    return;
  }

  // Validar mínimo 8 dígitos reales
  const digitos = telefono.replace(/\D/g,''); // quita todo excepto números
  if (digitos.length < 8) {
    alert("El teléfono debe contener al menos 8 dígitos");
    return;
  }

  clearInterval(refrescoInterval);

  const url = `${API_URL}?accion=reserva&dia=${encodeURIComponent(dia)}&horario=${encodeURIComponent(horario)}&nombre=${encodeURIComponent(nombre)}&telefono=${encodeURIComponent(telefono)}`;

  try {
    const res = await fetch(url);
    const data = await res.json();
    if (data.status==="ok") {
      alert(`✅ Te has apuntado correctamente a ${dia} de ${horario}, muchas gracias por colaborar.`);
      location.reload();
    } else if (data.status==="sin_cupos") { 
      alert("❌ Ya no quedan cupos"); 
      cargarTurnos(); 
    } else { 
      alert("⚠️ Error: "+data.status); 
    }
  } catch(err) { 
    alert("❌ Error al conectar con el servidor"); 
    console.error(err); 
  } finally {
    setTimeout(() => {
      refrescoInterval = setInterval(cargarTurnos, 30000);
    }, 5000);
  }
}

// Inicializar
cargarTurnos();
refrescoInterval = setInterval(cargarTurnos, 30000);
</script>
</body>
</html>

